name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  NODE_VERSION: '20.x'

jobs:
  build:
    name: Build Next.js
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma Client
        run: npm run generate
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      - name: Build Next.js application
        run: npm run build
        env:
          NODE_ENV: production

      - name: Build seed (TS ‚Üí CJS)
        run: npm run build:seed

      - name: Archive build for deployment
        run: |
          tar -czf release.tar.gz .next package.json package-lock.json public node_modules prisma prisma-seed
        shell: bash

      # N'uploader que sur main pour limiter le quota (les PR n'ont pas besoin de l'artifact)
      - name: Upload build artifact
        if: github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: nextjs-build
          path: release.tar.gz
          retention-days: 2

  type-check:
    name: Type Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run TypeScript type check
        run: npx tsc --noEmit

  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    needs: [ build, type-check ]
    if: github.ref == 'refs/heads/main' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch')

    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: nextjs-build
          path: ./deploy

      # Fichier √† la racine pour que le SCP le d√©pose directement dans target 
      - name: Prepare file for SCP
        run: mv deploy/release.tar.gz release.tar.gz

      - name: Copy build to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          source: "release.tar.gz"
          target: ${{ secrets.VPS_DEPLOY_PATH || '/home/deploy/Industriel_RH' }}

      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          GITHUB_SHA: ${{ github.sha }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          envs: GITHUB_SHA,DATABASE_URL
          script: |
            set -e
            DEPLOY_PATH="${{ secrets.VPS_DEPLOY_PATH || '/home/deploy/Industriel_RH' }}"

            echo "üìå D√©ploiement du build sur le serveur"
            mkdir -p "$DEPLOY_PATH"
            cd "$DEPLOY_PATH"

            # L'action SCP peut d√©poser le fichier en release.tar.gz ou dans un sous-dossier
            if [ -f release.tar.gz ]; then
              TARBALL="release.tar.gz"
            elif [ -f deploy/release.tar.gz ]; then
              TARBALL="deploy/release.tar.gz"
            else
              echo "Contenu de $DEPLOY_PATH :"
              ls -la
              echo "‚ùå release.tar.gz introuvable"
              exit 1
            fi

            # Supprimer l'ancien build (fichiers parfois cr√©√©s par PM2 avec permissions diff√©rentes)
            chmod -R u+rwX .next 2>/dev/null || true
            rm -rf .next node_modules package.json package-lock.json public prisma prisma-seed || sudo rm -rf .next node_modules package.json package-lock.json public prisma prisma-seed

            # Extraire le build
            tar -xzf "$TARBALL"
            rm -f release.tar.gz deploy/release.tar.gz

            echo "‚úÖ Build extrait sur le serveur"

            # Migrations Prisma (base locale sur le VPS)
            npx prisma migrate deploy

            # Red√©marrage PM2
            pm2 delete industriel-rh || true
            pm2 start npm --name "industriel-rh" -- start

            echo "‚úÖ D√©ploiement termin√© avec succ√®s!"
