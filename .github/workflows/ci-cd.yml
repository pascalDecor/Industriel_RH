name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  NODE_VERSION: '20.x'

jobs:
  build:
    name: Build Next.js
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma Client
        run: npm run generate
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL || 'postgresql://user:password@localhost:5432/db' }}

      - name: Build Next.js application
        run: npm run build
        env:
          NODE_ENV: production

      - name: Archive build for deployment
        run: |
          tar -czf release.tar.gz .next package.json package-lock.json public node_modules
        shell: bash

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: nextjs-build
          path: release.tar.gz

  type-check:
    name: Type Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run TypeScript type check
        run: npx tsc --noEmit

  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    needs: [ build, type-check ]
    if: github.ref == 'refs/heads/main' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch')

    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: nextjs-build
          path: ./deploy

      - name: Copy build to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          source: "deploy/release.tar.gz"
          target: ${{ secrets.VPS_DEPLOY_PATH || '/home/deploy/Industriel_RH' }}

      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          GITHUB_SHA: ${{ github.sha }}
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          script: |
            set -e
            DEPLOY_PATH="${{ secrets.VPS_DEPLOY_PATH || '/home/deploy/Industriel_RH' }}"

            echo "üìå D√©ploiement du build sur le serveur"

            mkdir -p "$DEPLOY_PATH"
            cd "$DEPLOY_PATH"

            if [ ! -f release.tar.gz ]; then
              echo "‚ùå release.tar.gz introuvable dans $DEPLOY_PATH"
              exit 1
            fi

            # Supprimer l'ancien build (conserver le reste du repo si pr√©sent)
            rm -rf .next node_modules package.json package-lock.json public

            # Extraire le build copi√© par l'√©tape SCP
            tar -xzf release.tar.gz
            rm release.tar.gz

            echo "‚úÖ Build extrait sur le serveur"

            # Red√©marrage PM2
            pm2 delete industriel-rh || true
            pm2 start npm --name "industriel-rh" -- start

            echo "‚úÖ D√©ploiement termin√© avec succ√®s!"
